================================================================================
FINANZIA - COMANDOS R√ÅPIDOS DE MIGRACI√ìN A DIGITAL OCEAN
================================================================================

Fecha: 2026-01-26
Sistema: Microfinanzas
Base de datos: micro_app (MySQL 8.0)

================================================================================
PASO 1: GENERAR SOLICITUDES COMPLETAS (OBLIGATORIO)
================================================================================

cd C:\Users\javie\OneDrive\Documentos\DESARROLLO\MICRO
python generate_solicitudes_complete.py

Resultado esperado:
‚úÖ Archivo generado exitosamente: 05_generate_solicitudes_mysql.sql
üìä Total de solicitudes generadas: 170

================================================================================
PASO 2A: IMPORTACI√ìN AUTOM√ÅTICA (RECOMENDADO)
================================================================================

# Reemplazar <DATOS_DIGITAL_OCEAN> con valores reales

mysql -h shark-app-xxxxx.ondigitalocean.app ^
      -P 25060 ^
      -u doadmin ^
      -p ^
      --ssl-mode=REQUIRED ^
      micro_app < MASTER_import_digital_ocean_mysql.sql

# Tiempo estimado: 5 minutos
# Incluye verificaciones autom√°ticas

================================================================================
PASO 2B: IMPORTACI√ìN MANUAL (CONTROL TOTAL)
================================================================================

# Ejecutar cada script en orden:

# 1. Configuraci√≥n base (20 seg)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 00_setup_base_mysql.sql

# 2. Personas (10 seg)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 01_insert_personas_mysql.sql

# 3. Direcciones (10 seg)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 02_insert_direcciones_mysql.sql

# 4. Solicitudes (30 seg) - DESPU√âS DE GENERAR CON PYTHON
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 05_generate_solicitudes_mysql.sql

# 5. Pr√©stamos (1 min)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 03_insert_prestamos_mysql.sql

# 6. Vincular (5 seg)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 06_update_prestamos_add_solicitudes.sql

# 7. Pagos (2 min)
mysql -h <HOST> -P 25060 -u <USER> -p micro_app < 04_insert_pagos_mysql.sql

================================================================================
PASO 3: VERIFICACI√ìN R√ÅPIDA
================================================================================

# Conectar a MySQL
mysql -h <HOST> -P 25060 -u <USER> -p micro_app

# Verificar conteos (deben coincidir con lo esperado)
SELECT 'Personas' AS Tabla, COUNT(*) AS Registros FROM persona
UNION ALL SELECT 'Direcciones', COUNT(*) FROM direccion
UNION ALL SELECT 'Solicitudes', COUNT(*) FROM solicitud
UNION ALL SELECT 'Pr√©stamos', COUNT(*) FROM prestamo
UNION ALL SELECT 'Pagos', COUNT(*) FROM pago;

/* Resultado esperado:
Personas:     67
Direcciones:  67
Solicitudes:  170
Pr√©stamos:    170
Pagos:        ~969
*/

# Verificar integridad (deben devolver 0)
SELECT 'Direcciones sin persona' AS Check, COUNT(*) AS Problemas
FROM direccion d LEFT JOIN persona p ON d.idPersona = p.idPersona
WHERE p.idPersona IS NULL;

SELECT 'Pr√©stamos sin solicitud' AS Check, COUNT(*) AS Problemas
FROM prestamo WHERE solicitudId IS NULL;

SELECT 'Pagos sin pr√©stamo' AS Check, COUNT(*) AS Problemas
FROM pago pg LEFT JOIN prestamo pr ON pg.prestamoId = pr.id
WHERE pr.id IS NULL;

/* Resultado esperado: 0 problemas en cada verificaci√≥n */

================================================================================
PASO 4: CONFIGURAR SEGURIDAD
================================================================================

# 1. Generar nuevo password hash (ejecutar en Node.js)
const bcrypt = require('bcrypt');
const hash = await bcrypt.hash('TuPasswordSeguro123!', 10);
console.log(hash);

# 2. Actualizar password en MySQL
UPDATE users
SET password = '$2b$10$TU_HASH_BCRYPT_GENERADO_AQUI'
WHERE email = 'admin@finanzia.com';

# 3. Crear usuario asesor (ejemplo)
SET @asesorRolId = (SELECT id FROM rol WHERE codigo = 'ASESOR');
INSERT INTO users (email, password, firstName, lastName, isActive, rolId)
VALUES ('asesor@finanzia.com', '$2b$10$HASH...', 'Asesor', 'Ejemplo', 1, @asesorRolId);

================================================================================
CONSULTAS √öTILES POST-IMPORTACI√ìN
================================================================================

# Estado de cartera
SELECT
    estado,
    COUNT(*) AS Cantidad,
    CONCAT('$', FORMAT(SUM(saldoCapital), 2)) AS 'Saldo Capital',
    CONCAT('$', FORMAT(SUM(totalPagar), 2)) AS 'Total a Cobrar'
FROM prestamo
GROUP BY estado;

# Clientes con pr√©stamos activos
SELECT
    p.nombre,
    p.apellido,
    COUNT(pr.id) AS 'Total Pr√©stamos',
    SUM(pr.saldoCapital) AS 'Saldo Pendiente'
FROM persona p
INNER JOIN prestamo pr ON p.idPersona = pr.personaId
WHERE pr.estado = 'VIGENTE'
GROUP BY p.idPersona, p.nombre, p.apellido
ORDER BY SUM(pr.saldoCapital) DESC;

# Pr√©stamos pr√≥ximos a vencer (30 d√≠as)
SELECT
    pr.numeroCredito,
    p.nombre,
    p.apellido,
    pr.fechaVencimiento,
    pr.saldoCapital
FROM prestamo pr
INNER JOIN persona p ON pr.personaId = p.idPersona
WHERE pr.estado = 'VIGENTE'
  AND pr.fechaVencimiento BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 30 DAY)
ORDER BY pr.fechaVencimiento;

# Pr√©stamos en mora
SELECT
    pr.numeroCredito,
    p.nombre,
    p.apellido,
    pr.diasMora,
    CONCAT('$', FORMAT(pr.capitalMora, 2)) AS 'Capital en Mora',
    CONCAT('$', FORMAT(pr.interesMora, 2)) AS 'Inter√©s Moratorio'
FROM prestamo pr
INNER JOIN persona p ON pr.personaId = p.idPersona
WHERE pr.estado = 'MORA'
ORDER BY pr.diasMora DESC;

# Actividad de pagos reciente (√∫ltimos 30 d√≠as)
SELECT
    DATE(pg.fechaPago) AS Fecha,
    COUNT(*) AS 'Pagos Realizados',
    CONCAT('$', FORMAT(SUM(pg.montoPagado), 2)) AS 'Monto Total'
FROM pago pg
WHERE pg.fechaPago >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(pg.fechaPago)
ORDER BY DATE(pg.fechaPago) DESC;

# Resumen por l√≠nea de cr√©dito
SELECT
    lc.nombre AS 'L√≠nea',
    tc.nombre AS 'Tipo Cr√©dito',
    COUNT(s.id) AS 'Solicitudes',
    COUNT(pr.id) AS 'Pr√©stamos',
    CONCAT('$', FORMAT(SUM(pr.montoDesembolsado), 2)) AS 'Desembolsado',
    CONCAT('$', FORMAT(SUM(pr.saldoCapital), 2)) AS 'Saldo Pendiente'
FROM linea_credito lc
INNER JOIN tipo_credito tc ON lc.id = tc.lineaCreditoId
LEFT JOIN solicitud s ON tc.id = s.tipoCreditoId
LEFT JOIN prestamo pr ON s.id = pr.solicitudId
GROUP BY lc.id, lc.nombre, tc.id, tc.nombre
ORDER BY COUNT(pr.id) DESC;

================================================================================
COMANDOS DE MANTENIMIENTO
================================================================================

# Backup manual de base de datos
mysqldump -h <HOST> -P 25060 -u <USER> -p \
    --ssl-mode=REQUIRED \
    micro_app > backup_micro_app_$(date +%Y%m%d).sql

# Optimizar tablas (ejecutar mensualmente)
OPTIMIZE TABLE persona, direccion, solicitud, prestamo, pago;

# Ver tama√±o de base de datos
SELECT
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'micro_app'
GROUP BY table_schema;

# Ver uso de √≠ndices
SELECT
    TABLE_NAME,
    INDEX_NAME,
    CARDINALITY,
    SEQ_IN_INDEX
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'micro_app'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;

================================================================================
SOLUCI√ìN R√ÅPIDA DE PROBLEMAS
================================================================================

# Problema: "Table doesn't exist"
# Soluci√≥n: Ejecutar migraciones de TypeORM
cd C:\Users\javie\OneDrive\Documentos\DESARROLLO\MICRO\micro-app\backend
npm run migration:run

# Problema: "Foreign key constraint fails"
# Soluci√≥n: Verificar orden de importaci√≥n o deshabilitar checks temporalmente
SET FOREIGN_KEY_CHECKS = 0;
-- Ejecutar importaci√≥n
SET FOREIGN_KEY_CHECKS = 1;

# Problema: "Duplicate entry"
# Soluci√≥n: Limpiar tablas en orden inverso
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE pago;
TRUNCATE TABLE prestamo;
TRUNCATE TABLE solicitud;
TRUNCATE TABLE direccion;
TRUNCATE TABLE persona;
SET FOREIGN_KEY_CHECKS = 1;
-- Reiniciar importaci√≥n

# Problema: Pr√©stamos sin solicitud
# Soluci√≥n: Ejecutar script de vinculaci√≥n
SOURCE 06_update_prestamos_add_solicitudes.sql;

# Problema: Solo 5 solicitudes importadas
# Causa: No se gener√≥ el archivo completo con Python
# Soluci√≥n:
python generate_solicitudes_complete.py
# Luego reimportar: SOURCE 05_generate_solicitudes_mysql.sql;

================================================================================
CONFIGURACI√ìN DE DIGITAL OCEAN
================================================================================

# Habilitar backups autom√°ticos (desde panel de DO)
Database ‚Üí Settings ‚Üí Backups ‚Üí Enable Daily Backups

# Configurar firewall (whitelist IP)
Database ‚Üí Settings ‚Üí Trusted Sources ‚Üí Add Source
IP: [TU_IP_PUBLICA]
Nota: "Oficina - Importaci√≥n Inicial"

# Configurar alertas
Database ‚Üí Settings ‚Üí Alerts
- Disk usage > 80%
- CPU usage > 90%
- Memory usage > 90%

# Ver m√©tricas en tiempo real
Database ‚Üí Insights ‚Üí Performance
- Queries per second
- Active connections
- Disk I/O
- CPU usage

================================================================================
CHECKLIST DE VERIFICACI√ìN FINAL
================================================================================

Antes de importar:
[ ] Base de datos 'micro_app' existe
[ ] TypeORM migraciones ejecutadas
[ ] Firewall configurado (IP whitelisted)
[ ] Archivo 05_generate_solicitudes_mysql.sql completo (170 solicitudes)

Durante importaci√≥n:
[ ] Sin errores de foreign key
[ ] Sin errores de duplicate entry
[ ] Sin errores de table doesn't exist
[ ] Progreso visible

Despu√©s de importar:
[ ] Conteo personas: 67
[ ] Conteo direcciones: 67
[ ] Conteo solicitudes: 170
[ ] Conteo pr√©stamos: 170
[ ] Conteo pagos: ~969
[ ] Verificaciones integridad: 0 problemas
[ ] Todos pr√©stamos tienen solicitud
[ ] Password admin actualizado
[ ] Login en aplicaci√≥n funciona
[ ] Dashboard muestra datos correctos

================================================================================
CONTACTOS Y RECURSOS
================================================================================

Documentaci√≥n detallada:
- README_MIGRACION_DIGITAL_OCEAN.md (gu√≠a completa paso a paso)
- RESUMEN_MIGRACION.md (resumen ejecutivo)
- INDICE_ARCHIVOS_MIGRACION.md (√≠ndice de archivos)

Scripts generados:
- 00_setup_base_mysql.sql (configuraci√≥n base)
- 05_generate_solicitudes_mysql.sql (solicitudes - generar con Python)
- 06_update_prestamos_add_solicitudes.sql (vincular pr√©stamo-solicitud)
- MASTER_import_digital_ocean_mysql.sql (script maestro)
- generate_solicitudes_complete.py (generador Python)

Digital Ocean:
- Panel: https://cloud.digitalocean.com/databases
- Documentaci√≥n: https://docs.digitalocean.com/products/databases/mysql/

TypeORM:
- Documentaci√≥n: https://typeorm.io/
- Migraciones: https://typeorm.io/migrations

================================================================================
VERSI√ìN Y AUTOR√çA
================================================================================

Versi√≥n: 1.0
Fecha: 2026-01-26
Sistema: FINANZIA - Microfinanzas
Plataforma: Digital Ocean MySQL 8.0
Total de datos: ~1,514 registros

Archivos generados: 11
- SQL Scripts: 7
- Python Scripts: 1
- Documentaci√≥n: 3

Estado: Listo para importaci√≥n (despu√©s de generar solicitudes)

================================================================================
FIN DEL DOCUMENTO
================================================================================
