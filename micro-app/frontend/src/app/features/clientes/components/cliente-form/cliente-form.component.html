<div class="cliente-form-container">
  <div class="header">
    <button mat-icon-button (click)="cancel()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>{{ isEditMode() ? 'Editar' : 'Nuevo' }} Cliente</h1>
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else {
    <mat-stepper orientation="vertical" linear #stepper>
      <!-- Paso 1: Datos Personales -->
      <mat-step [stepControl]="datosPersonalesForm" label="Datos Personales">
        <form [formGroup]="datosPersonalesForm">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Nombre</mat-label>
              <input matInput formControlName="nombre" />
              @if (datosPersonalesForm.get('nombre')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Apellido</mat-label>
              <input matInput formControlName="apellido" />
              @if (datosPersonalesForm.get('apellido')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha de Nacimiento</mat-label>
              <input matInput [matDatepicker]="pickerNac" formControlName="fechaNacimiento" />
              <mat-datepicker-toggle matIconSuffix [for]="pickerNac"></mat-datepicker-toggle>
              <mat-datepicker #pickerNac></mat-datepicker>
              @if (datosPersonalesForm.get('fechaNacimiento')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sexo</mat-label>
              <mat-select formControlName="sexo">
                @for (sexo of sexoOptions; track sexo) {
                  <mat-option [value]="sexo">{{ sexo }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nacionalidad</mat-label>
              <input matInput formControlName="nacionalidad" />
              @if (datosPersonalesForm.get('nacionalidad')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estado Civil</mat-label>
              <mat-select formControlName="estadoCivil">
                @for (estado of estadoCivilOptions; track estado) {
                  <mat-option [value]="estado">{{ estado }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Teléfono</mat-label>
              <input matInput formControlName="telefono" type="tel" />
              <mat-icon matSuffix>phone</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Correo Electrónico</mat-label>
              <input matInput formControlName="correoElectronico" type="email" />
              <mat-icon matSuffix>email</mat-icon>
              @if (datosPersonalesForm.get('correoElectronico')?.hasError('email')) {
                <mat-error>Correo inválido</mat-error>
              }
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>
          <h3 class="section-title">Documento de Identidad</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Número de DUI</mat-label>
              <input matInput formControlName="numeroDui" placeholder="00000000-0" />
              @if (datosPersonalesForm.get('numeroDui')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha de Emisión</mat-label>
              <input matInput [matDatepicker]="pickerEmision" formControlName="fechaEmisionDui" />
              <mat-datepicker-toggle matIconSuffix [for]="pickerEmision"></mat-datepicker-toggle>
              <mat-datepicker #pickerEmision></mat-datepicker>
              @if (datosPersonalesForm.get('fechaEmisionDui')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Lugar de Emisión</mat-label>
              <input matInput formControlName="lugarEmisionDui" />
              @if (datosPersonalesForm.get('lugarEmisionDui')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperNext color="primary">
              Siguiente <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Paso 2: Dirección -->
      <mat-step [stepControl]="direccionForm" label="Dirección">
        <form [formGroup]="direccionForm">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Departamento</mat-label>
              <mat-select
                formControlName="departamentoId"
                (selectionChange)="onDepartamentoDireccionChange($event.value)"
              >
                @for (dep of departamentos(); track dep.id) {
                  <mat-option [value]="dep.id">{{ dep.nombre }}</mat-option>
                }
              </mat-select>
              @if (direccionForm.get('departamentoId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Municipio</mat-label>
              <mat-select
                formControlName="municipioId"
                (selectionChange)="onMunicipioDireccionChange($event.value)"
              >
                @for (mun of municipiosDireccion(); track mun.id) {
                  <mat-option [value]="mun.id">{{ mun.nombre }}</mat-option>
                }
              </mat-select>
              @if (direccionForm.get('municipioId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Distrito</mat-label>
              <mat-select formControlName="distritoId">
                @for (dist of distritosDireccion(); track dist.id) {
                  <mat-option [value]="dist.id">{{ dist.nombre }}</mat-option>
                }
              </mat-select>
              @if (direccionForm.get('distritoId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Detalle de la Dirección</mat-label>
              <textarea matInput formControlName="detalleDireccion" rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon> Anterior
            </button>
            <button mat-button matStepperNext color="primary">
              Siguiente <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Paso 3: Actividad Económica -->
      <mat-step [stepControl]="actividadEconomicaForm" label="Actividad Económica">
        <form [formGroup]="actividadEconomicaForm">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Tipo de Actividad</mat-label>
              <mat-select formControlName="tipoActividad">
                @for (tipo of tipoActividadOptions; track tipo) {
                  <mat-option [value]="tipo">{{ tipo }}</mat-option>
                }
              </mat-select>
              @if (actividadEconomicaForm.get('tipoActividad')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nombre de Empresa</mat-label>
              <input matInput formControlName="nombreEmpresa" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Cargo / Ocupación</mat-label>
              <input matInput formControlName="cargoOcupacion" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Ingresos Mensuales</mat-label>
              <input matInput formControlName="ingresosMensuales" type="number" />
              <span matTextPrefix>$&nbsp;</span>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>
          <h3 class="section-title">Dirección de Trabajo</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Departamento</mat-label>
              <mat-select
                formControlName="departamentoId"
                (selectionChange)="onDepartamentoActividadChange($event.value)"
              >
                @for (dep of departamentos(); track dep.id) {
                  <mat-option [value]="dep.id">{{ dep.nombre }}</mat-option>
                }
              </mat-select>
              @if (actividadEconomicaForm.get('departamentoId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Municipio</mat-label>
              <mat-select
                formControlName="municipioId"
                (selectionChange)="onMunicipioActividadChange($event.value)"
              >
                @for (mun of municipiosActividad(); track mun.id) {
                  <mat-option [value]="mun.id">{{ mun.nombre }}</mat-option>
                }
              </mat-select>
              @if (actividadEconomicaForm.get('municipioId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Distrito</mat-label>
              <mat-select formControlName="distritoId">
                @for (dist of distritosActividad(); track dist.id) {
                  <mat-option [value]="dist.id">{{ dist.nombre }}</mat-option>
                }
              </mat-select>
              @if (actividadEconomicaForm.get('distritoId')?.hasError('required')) {
                <mat-error>Requerido</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Detalle de la Dirección</mat-label>
              <textarea matInput formControlName="detalleDireccion" rows="3"></textarea>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>
          <div class="coordinates-section">
            <div class="section-header-coords">
              <h3 class="section-title">Coordenadas GPS</h3>
              <div class="location-buttons">
                <button
                  mat-raised-button
                  color="accent"
                  type="button"
                  (click)="getCurrentLocation()"
                  [disabled]="isGettingLocation()"
                >
                  @if (isGettingLocation()) {
                    <mat-spinner diameter="18"></mat-spinner>
                  } @else {
                    <mat-icon>my_location</mat-icon>
                  }
                  Obtener Ubicación
                </button>
                @if (actividadEconomicaForm.get('latitud')?.value) {
                  <button mat-button color="warn" type="button" (click)="clearLocation()">
                    <mat-icon>clear</mat-icon> Limpiar
                  </button>
                }
              </div>
            </div>

            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Latitud</mat-label>
                <input matInput formControlName="latitud" type="number" step="any" readonly />
                <mat-icon matSuffix>north</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Longitud</mat-label>
                <input matInput formControlName="longitud" type="number" step="any" readonly />
                <mat-icon matSuffix>east</mat-icon>
              </mat-form-field>
            </div>

            @if (actividadEconomicaForm.get('latitud')?.value && actividadEconomicaForm.get('longitud')?.value) {
              <a
                mat-stroked-button
                color="primary"
                [href]="'https://www.google.com/maps?q=' + actividadEconomicaForm.get('latitud')?.value + ',' + actividadEconomicaForm.get('longitud')?.value"
                target="_blank"
                class="view-map-btn"
              >
                <mat-icon>map</mat-icon> Ver en Google Maps
              </a>
            }
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon> Anterior
            </button>
            <button mat-button matStepperNext color="primary">
              Siguiente <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Paso 4: Referencias -->
      <mat-step label="Referencias">
        <!-- Referencias Personales -->
        <div class="references-section">
          <div class="section-header">
            <h3>Referencias Personales</h3>
            <button mat-mini-fab color="accent" type="button" (click)="openReferenciaPersonalDialog()">
              <mat-icon>add</mat-icon>
            </button>
          </div>

          @if (referenciasPersonales().length > 0) {
            <!-- Vista Desktop: Tabla -->
            <div class="desktop-view">
              <table mat-table [dataSource]="referenciasPersonales()" class="full-width">
                <ng-container matColumnDef="nombre">
                  <th mat-header-cell *matHeaderCellDef>Nombre</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.nombreReferencia }}</td>
                </ng-container>

                <ng-container matColumnDef="relacion">
                  <th mat-header-cell *matHeaderCellDef>Relación</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.relacion }}</td>
                </ng-container>

                <ng-container matColumnDef="telefono">
                  <th mat-header-cell *matHeaderCellDef>Teléfono</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.telefonoReferencia || '-' }}</td>
                </ng-container>

                <ng-container matColumnDef="acciones">
                  <th mat-header-cell *matHeaderCellDef>Acciones</th>
                  <td mat-cell *matCellDef="let ref; let i = index">
                    <button mat-icon-button color="primary" (click)="editReferenciaPersonal(ref, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeReferenciaPersonal(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumnsPersonales"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsPersonales"></tr>
              </table>
            </div>

            <!-- Vista Mobile: Cards -->
            <div class="mobile-view">
              @for (ref of referenciasPersonales(); track ref; let i = $index) {
                <mat-card class="reference-card-mobile">
                  <mat-card-header>
                    <mat-card-title>{{ ref.nombreReferencia }}</mat-card-title>
                    <mat-card-subtitle>{{ ref.relacion }}</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    @if (ref.telefonoReferencia) {
                      <p><mat-icon class="inline-icon">phone</mat-icon> {{ ref.telefonoReferencia }}</p>
                    }
                    @if (ref.direccionReferencia) {
                      <p><mat-icon class="inline-icon">location_on</mat-icon> {{ ref.direccionReferencia }}</p>
                    }
                  </mat-card-content>
                  <mat-card-actions align="end">
                    <button mat-icon-button color="primary" (click)="editReferenciaPersonal(ref, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeReferenciaPersonal(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </mat-card-actions>
                </mat-card>
              }
            </div>
          } @else {
            <p class="no-data">No hay referencias personales agregadas</p>
          }
        </div>

        <mat-divider></mat-divider>

        <!-- Referencias Familiares -->
        <div class="references-section">
          <div class="section-header">
            <h3>Referencias Familiares</h3>
            <button mat-mini-fab color="accent" type="button" (click)="openReferenciaFamiliarDialog()">
              <mat-icon>add</mat-icon>
            </button>
          </div>

          @if (referenciasFamiliares().length > 0) {
            <!-- Vista Desktop: Tabla -->
            <div class="desktop-view">
              <table mat-table [dataSource]="referenciasFamiliares()" class="full-width">
                <ng-container matColumnDef="nombre">
                  <th mat-header-cell *matHeaderCellDef>Nombre</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.nombreFamiliar }}</td>
                </ng-container>

                <ng-container matColumnDef="parentesco">
                  <th mat-header-cell *matHeaderCellDef>Parentesco</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.parentesco }}</td>
                </ng-container>

                <ng-container matColumnDef="telefono">
                  <th mat-header-cell *matHeaderCellDef>Teléfono</th>
                  <td mat-cell *matCellDef="let ref">{{ ref.telefonoFamiliar || '-' }}</td>
                </ng-container>

                <ng-container matColumnDef="acciones">
                  <th mat-header-cell *matHeaderCellDef>Acciones</th>
                  <td mat-cell *matCellDef="let ref; let i = index">
                    <button mat-icon-button color="primary" (click)="editReferenciaFamiliar(ref, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeReferenciaFamiliar(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumnsFamiliares"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumnsFamiliares"></tr>
              </table>
            </div>

            <!-- Vista Mobile: Cards -->
            <div class="mobile-view">
              @for (ref of referenciasFamiliares(); track ref; let i = $index) {
                <mat-card class="reference-card-mobile">
                  <mat-card-header>
                    <mat-card-title>{{ ref.nombreFamiliar }}</mat-card-title>
                    <mat-card-subtitle>{{ ref.parentesco }}</mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    @if (ref.telefonoFamiliar) {
                      <p><mat-icon class="inline-icon">phone</mat-icon> {{ ref.telefonoFamiliar }}</p>
                    }
                    @if (ref.direccionFamiliar) {
                      <p><mat-icon class="inline-icon">location_on</mat-icon> {{ ref.direccionFamiliar }}</p>
                    }
                  </mat-card-content>
                  <mat-card-actions align="end">
                    <button mat-icon-button color="primary" (click)="editReferenciaFamiliar(ref, i)">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="removeReferenciaFamiliar(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </mat-card-actions>
                </mat-card>
              }
            </div>
          } @else {
            <p class="no-data">No hay referencias familiares agregadas</p>
          }
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>
            <mat-icon>arrow_back</mat-icon> Anterior
          </button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="onSubmit()"
            [disabled]="isSaving()"
          >
            @if (isSaving()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <mat-icon>save</mat-icon>
              {{ isEditMode() ? 'Actualizar' : 'Guardar' }}
            }
          </button>
        </div>
      </mat-step>
    </mat-stepper>
  }
</div>
